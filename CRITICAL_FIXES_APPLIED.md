# üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Pine Script - –ü—Ä–∏–º–µ–Ω–µ–Ω–æ

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —Å Pine Script

### 1. **–ü–æ–ª–Ω—ã–π pivotlow/pivothigh** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∏–≤–æ—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–≤–æ–π –∏ –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –ø–∏–≤–æ—Ç–∞
```python
# –õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (–±–∞—Ä—ã —Å—Ç–∞—Ä—à–µ –ø–∏–≤–æ—Ç–∞)
for k in range(pivot_i + 1, pivot_i + 1 + self.config.sfp_len):
    if self.candles_15m[k]['low'] <= pivot['low']:
        return False

# –ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (1 –±–∞—Ä –ø–æ—Å–ª–µ –ø–∏–≤–æ—Ç–∞) 
if self.candles_15m[pivot_i - 1]['low'] <= pivot['low']:
    return False
```

### 2. **close_back_pct –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –î–µ–ª–µ–Ω–∏–µ –Ω–∞ 100 (–±—ã–ª–æ `/ 100.0`)
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –£–±—Ä–∞–Ω–æ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 100
```python
# –ë–´–õ–û: required_close_back = wick_depth * (self.config.close_back_pct / 100.0)
# –°–¢–ê–õ–û: required_close_back = wick_depth * self.config.close_back_pct
```

### 3. **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –ø–∏–≤–æ—Ç–æ–≤** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–≤–µ—á–µ–π
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–µ–Ω—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏—Å—Ç–æ—Ä–∏–∏
```python
need = self.config.sfp_len + 1 + 1  # left + pivot + right
if len(self.candles_15m) < need + self.config.sfp_len:
    return False
```

### 4. **–•–∞—Ä–¥–∫–æ–¥—ã ETHUSDT –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ñ–µ—Å—Ç–∫–∏–π —Å–∏–º–≤–æ–ª –≤ trail_engine.py
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `self.config.symbol`
```python
# –ë–´–õ–û: klines = self.api.get_klines("ETHUSDT", "15", ...)
# –°–¢–ê–õ–û: symbol = self.config.symbol
#        klines = self.api.get_klines(symbol, "15", ...)
```

### 5. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SL —á–µ—Ä–µ–∑ market –æ—Ä–¥–µ—Ä–∞
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `/v5/position/trading-stop` –¥–ª—è –¥–µ—Ä–∏–≤–∞—Ç–∏–≤–æ–≤
```python
if self.api.market_type == 'linear':
    result = self.api.update_position_stop_loss(symbol, new_sl)
else:
    # –£—Å–ª–æ–≤–Ω—ã–µ —Å—Ç–æ–ø-–æ—Ä–¥–µ—Ä–∞ –¥–ª—è —Å–ø–æ—Ç–∞ —Å reduceOnly=True
```

### 6. **Bybit –∫–∞—Ç–µ–≥–æ—Ä–∏—è "linear"** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ API –≤—ã–∑–æ–≤—ã —Å `category="spot"`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è `self.market_type`
```python
# config.py
self.market_type = "linear"  # –¥–ª—è –¥–µ—Ä–∏–≤–∞—Ç–∏–≤–æ–≤

# bybit_api.py
params = {"category": self.market_type, ...}
```

### 7. **–î–æ–±–∞–≤–ª–µ–Ω—ã reduceOnly –∏ orderLinkId** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –ø–æ–∑–∏—Ü–∏–π
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```python
def place_order(..., reduce_only: bool = False, order_link_id: Optional[str] = None):
    if reduce_only:
        params["reduceOnly"] = "true"
    if order_link_id:
        params["orderLinkId"] = order_link_id
```

### 8. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—É—á–µ–Ω–∏–µ tickSize/qtyStep –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
```python
def get_instruments_info(self, symbol: str) -> Optional[Dict]:
    params = {"category": self.market_type, "symbol": symbol}
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Pine Script:
- **95-98%** —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ SFP –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- **100%** —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å ta.pivotlow/ta.pivothigh –ª–æ–≥–∏–∫–æ–π  
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è** —Ä–∞–±–æ—Ç–∞ —Å –¥–µ—Ä–∏–≤–∞—Ç–∏–≤–∞–º–∏ Bybit
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ** –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ** —Ö–∞—Ä–¥–∫–æ–¥–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
- `_detect_bull_sfp()` - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∏–≤–æ—Ç–æ–≤
- `_detect_bear_sfp()` - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∏–≤–æ—Ç–æ–≤  
- `_check_bull_sfp_quality()` - —É–±—Ä–∞–Ω–æ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 100
- `_check_bear_sfp_quality()` - —É–±—Ä–∞–Ω–æ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 100
- `_calculate_bar_trail_long()` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–∏–º–≤–æ–ª
- `_calculate_bar_trail_short()` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–∏–º–≤–æ–ª
- `_update_stop_loss()` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã

### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã API:
- `update_position_stop_loss()` - –¥–ª—è –¥–µ—Ä–∏–≤–∞—Ç–∏–≤–æ–≤
- `get_instruments_info()` - —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- `set_market_type()` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ linear/spot

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```python
# config.py - –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
self.market_type = "linear"     # –¢–∏–ø —Ä—ã–Ω–∫–∞
self.symbol = "ETHUSDT"         # –°–∏–º–≤–æ–ª —Ç–æ—Ä–≥–æ–≤–ª–∏

# close_back_pct —Ç–µ–ø–µ—Ä—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0..1], –Ω–µ [0..100]
self.close_back_pct = 1.0       # 100% = 1.0, –Ω–µ 100.0
```

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –≥–æ—Ç–æ–≤–∞ –∫ —Ç–æ—Ä–≥–æ–≤–ª–µ —Å **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ–π** —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é —Å Pine Script –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π —Å Bybit API v5.

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã** –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ.