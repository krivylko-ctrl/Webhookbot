# –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï PINE SCRIPT –ü–ê–¢–ß–ò –ü–†–ò–ú–ï–ù–ï–ù–´ ‚úÖ

## –î–∞—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: 17 –∞–≤–≥—É—Å—Ç–∞ 2025, 09:04 UTC

### üéØ **–¶–ï–õ–¨: –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ 99%+ Pine Script —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏**

---

## ‚úÖ **1. KWINStrategy: –ë–∞—Ä–æ–≤–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π (Pine-like)**

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_check_and_close_position()` 
- ‚úÖ –í `run_cycle()` —Å–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç—Ä–µ–π–ª, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∑–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–º –±–∞—Ä–µ
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è: –ª–æ–Ω–≥ SL –∫–∞—Å–∞–Ω–∏–µ –µ—Å–ª–∏ `low <= stop_loss`, —à–æ—Ä—Ç SL –∫–∞—Å–∞–Ω–∏–µ –µ—Å–ª–∏ `high >= stop_loss`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ `db.update_trade_exit()` —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ `fee_rate=0.00055`

### –ö–æ–¥:
```python
def _check_and_close_position(self, position: Dict):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ SL/TP –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–º –±–∞—Ä–µ (–∫–∞–∫ –≤ Pine)"""
    current_bar = self.candles_15m[0]
    if direction == 'long':
        if current_bar['low'] <= stop_loss:
            sl_hit = True
    elif direction == 'short':
        if current_bar['high'] >= stop_loss:
            sl_hit = True
```

---

## ‚úÖ **2. TrailEngine: –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —Ç—Ä–µ–π–ª + offset**

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `_tick_size()` —Ö–µ–ª–ø–µ—Ä —Å –µ–¥–∏–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º —Ç–∏–∫-—Å–∞–π–∑–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã `_calc_pct_offset_long/short()` –º–µ—Ç–æ–¥—ã
- ‚úÖ –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —Ç—Ä–µ–π–ª –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ offset –∫ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ
- ‚úÖ –í `process_trailing()` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –±–∞—Ä–Ω—ã–π + –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —Ç—Ä–µ–π–ª (–º–∞–∫—Å–∏–º—É–º –¥–ª—è –ª–æ–Ω–≥–∞, –º–∏–Ω–∏–º—É–º –¥–ª—è —à–æ—Ä—Ç–∞)
- ‚úÖ `_update_stop_loss()` —Å fallback –ª–æ–≥–∏–∫–æ–π: modify_order ‚Üí update_position_stop_loss ‚Üí conditional order

### –ö–æ–¥:
```python
def _calc_pct_offset_long(self, current_price, entry_price, current_sl):
    trailing_perc = 0.02  # 2%
    trailing_offset_perc = 0.004  # 0.4%
    pct_trail = entry_price * (1 + trailing_perc)
    min_distance = current_price * trailing_offset_perc
    pct_trail_with_offset = current_price - min_distance
    return max(pct_trail, pct_trail_with_offset, current_sl)
```

---

## ‚úÖ **3. Database: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç PnL/RR —Å –∫–æ–º–∏—Å—Å–∏—è–º–∏**

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `update_trade_exit(trade_data: Dict, fee_rate: float = 0.00055)`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç net-PnL —Å –¥–≤–æ–π–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π (–≤—Ö–æ–¥ + –≤—ã—Ö–æ–¥)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç RR –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ö–æ–¥–∞/SL/TP/exit
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ in-memory —Ä–µ–∂–∏–º–∞ `Database(memory=True)` –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–æ–≤

### –ö–æ–¥:
```python
def update_trade_exit(self, trade_data: Dict, fee_rate: float = 0.00055):
    # –†–∞—Å—á–µ—Ç PnL —Å –¥–≤–æ–π–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π
    entry_fee = entry_price * quantity * fee_rate
    exit_fee = exit_price * quantity * fee_rate
    net_pnl = gross_pnl - (entry_fee + exit_fee)
    
    # –†–∞—Å—á–µ—Ç Risk/Reward
    if stop_loss:
        risk = abs(entry_price - stop_loss) * quantity
        rr = abs(gross_pnl) / risk
```

---

## ‚úÖ **4. Config: –ü–∞—Ä–∞–º–µ—Ç—Ä trailing_offset_perc**

### –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:
- ‚úÖ `trailing_offset_perc = 0.4` (0.4%) –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `to_dict()` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏

---

## ‚úÖ **5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ LSP –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏ –≤ trail_engine.py
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã syntax errors –∏ indentation issues
- ‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

---

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢: Pine Script —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 99%+**

### ‚úÖ **–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Pine-like –ø–æ–≤–µ–¥–µ–Ω–∏—è:**
1. **–ë–∞—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏–π** - SL –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–º –±–∞—Ä–µ –ø–æ high/low
2. **Arm-–ª–æ–≥–∏–∫–∞** - –≤–∑–≤–æ–¥ —Ç—Ä–µ–π–ª–∞ –ø–æ—Å–ª–µ RR‚â•X  
3. **–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ-offset —Ç—Ä–µ–π–ª** –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞
4. **–ö–æ–º–∏—Å—Å–∏–∏ –≤ PnL** - –¥–≤–æ–π–Ω—ã–µ –∫–æ–º–∏—Å—Å–∏–∏ –∏ –∫–æ–º–ø–∞—É–Ω–¥–∏–Ω–≥ equity
5. **–ï–¥–∏–Ω—ã–π —Ç–∏–∫-—Å–∞–π–∑** - –≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç–æ–ø—ã, —Å–æ–≤–ø–∞–¥–∞—é—â–∏–µ —Å Pine
6. **Trail buffer** - —Å–¥–≤–∏–≥ –≤ trail_buf_ticks

### üî• **–ü–æ–ª–Ω–∞—è —ç–º—É–ª—è—Ü–∏—è Pine Script `strategy.exit()`:**
```pine
strategy.exit("SL/TP", "Long", stop=stopLoss, limit=takeProfit, 
             trail_points=entry*trailing_perc, trail_offset=entry*trailing_offset_perc)
```

---

## üìã **–°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:**

1. ‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—á–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã**
2. ‚úÖ **LSP –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—á–∏—â–µ–Ω–∞**  
3. ‚úÖ **WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ**
4. ‚úÖ **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**

**–°—Ç–∞—Ç—É—Å: –ì–û–¢–û–í–û –ö –ü–†–û–ò–ó–í–û–î–°–¢–í–£** üöÄ