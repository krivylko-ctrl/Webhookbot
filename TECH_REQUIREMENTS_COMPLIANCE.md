# ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º - –í–´–ü–û–õ–ù–ï–ù–û

## 1. –¢–∞–π–º–∏–Ω–≥, —Å–≤–µ—á–∏, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º

### ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ 15m —Å–≤–µ—á–∏
- **–í—Ö–æ–¥—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è** –±–∞—Ä–∞
- **–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏:** –≤—Å—ë –≤ UTC, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∫ 900-—Å–µ–∫—É–Ω–¥–Ω—ã–º –≥—Ä–∞–Ω–∏—Ü–∞–º  
- **–ï–¥–∏–Ω—ã–π –ø—É—Ç—å –∫–æ–¥–∞:** –æ—Ñ—Ñ–ª–∞–π–Ω-–±—ç–∫—Ç–µ—Å—Ç –∏ –æ–Ω–ª–∞–π–Ω –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é `on_bar_close()`

```python
# kwin_strategy.py
aligned_timestamp = (current_timestamp // 900) * 900
if self.last_processed_time != aligned_timestamp:
    self.on_bar_close()  # –ï–¥–∏–Ω—ã–π –ø—É—Ç—å –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω/–æ–Ω–ª–∞–π–Ω
```

## 2. SFP –¥–µ—Ç–µ–∫—Ü–∏—è (–∂—ë—Å—Ç–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –∫ Pine)

### ‚úÖ –ü–æ–≤–æ—Ä–æ—Ç (pivot) —Å –ª–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π  
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ sfpLen –±–∞—Ä–æ–≤ —Å–ª–µ–≤–∞ –∏ 1 –±–∞—Ä —Å–ø—Ä–∞–≤–∞** (—Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Pine Script)
- **closeBackPct –±–µ–∑ /100:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –¥–æ–ª—è [0..1], –Ω–µ –ø—Ä–æ—Ü–µ–Ω—Ç
- **–ë–∞—Ä [1] —Ç–æ–ª—å–∫–æ –∏–∑ –∑–∞–∫—Ä—ã—Ç—ã—Ö:** –≤—Å–µ `low_15m[1]/high_15m[1]` –∏–∑ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç—ã—Ö –±–∞—Ä–æ–≤

```python
# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∏–≤–æ—Ç–∞ (–ª–µ–≤–∞—è + –ø—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
for k in range(pivot_i + 1, pivot_i + 1 + self.config.sfp_len):
    if self.candles_15m[k]['low'] <= pivot['low']:
        return False

# closeBackPct –∫–∞–∫ –¥–æ–ª—è [0..1]
required_close_back = wick_depth * self.config.close_back_pct  # –±–µ–∑ /100
```

## 3. –û–±—ä—ë–º, —Ñ–∏–ª—å—Ç—Ä—ã, –∫–æ–º–∏—Å—Å–∏–∏

### ‚úÖ –ö–æ–º–∏—Å—Å–∏—è = 2√ó taker
- **–†–∞—Å—á—ë—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** entry_fee + exit_fee
- **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —à–∞–≥–æ–≤:** tick_size, qty_step –∏–∑ `/instruments-info`
- **–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Decimal:** –∏—Å–∫–ª—é—á–µ–Ω–∞ –ø–ª–∞–≤–∞—é—â–∞—è –æ—à–∏–±–∫–∞
- **–§–∏–ª—å—Ç—Ä minNetProfit:** —É—á—ë—Ç —Å–ø—Ä–µ–¥–∞/—Å–∫–æ–ª—å–∂–µ–Ω–∏—è (1-2 —Ç–∏–∫–∞)

```python
# utils.py
from decimal import Decimal, ROUND_HALF_UP, getcontext
getcontext().prec = 28

def calculate_fees(price, quantity, fee_rate=0.00055, both_sides=True):
    """–ö–æ–º–∏—Å—Å–∏–∏ = 2√ó taker (entry_fee + exit_fee)"""
    single_fee = price * quantity * fee_rate
    return single_fee * 2 if both_sides else single_fee
```

## 4. Smart-Trailing (ArmRR, BarTrail)

### ‚úÖ –ê–∫—Ç–∏–≤–∞—Ç–æ—Ä RR
- **R –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ –∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ SL:** –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã entry_price/entry_sl –≤ trade_state
- **BarTrail –ø–æ "–∑–∞–∫—Ä—ã—Ç—ã–º" –±–∞—Ä–∞–º:** `lowest(low, N)[1] / highest(high, N)[1]` - –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞—Ä
- **triggerBy:** –∑–∞–¥–∞–Ω `triggerBy="LastPrice"` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å TV

```python
# trail_engine.py
def _check_arm_rr(self, entry_price, entry_sl, current_price, direction):
    """–ê–∫—Ç–∏–≤–∞—Ç–æ—Ä RR: —Å—á–∏—Ç–∞–π R –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ –∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ SL"""
    if direction == 'long':
        initial_risk = entry_price - entry_sl
        current_profit = current_price - entry_price
        rr_ratio = current_profit / initial_risk if initial_risk > 0 else 0
        return rr_ratio >= self.config.arm_rr_ratio

# BarTrail —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–∫—Ä—ã—Ç—ã–º –±–∞—Ä–∞–º [1]
lookback_lows = [candle['low'] for candle in klines[1:self.config.trail_lookback + 1]]
```

### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SL –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º
- **–î–ª—è USDT-–ø–µ—Ä–ø—Å–æ–≤:** `POST /v5/position/trading-stop` (one-way)
- **reduceOnly –≤–µ–∑–¥–µ:** –≤—Å–µ —Å—Ç–æ–ø—ã/–≤—ã—Ö–æ–¥—ã —Å `reduceOnly=true`
- **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:** –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –∞–ø–¥–µ–π—Ç—ã —Å `orderLinkId`

```python
# bybit_api.py
def update_position_stop_loss(self, symbol, stop_loss):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SL –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º –¥–ª—è USDT-–ø–µ—Ä–ø—Å–æ–≤"""
    params = {
        "category": "linear",
        "symbol": symbol,
        "stopLoss": str(stop_loss),
        "triggerBy": "LastPrice"  # –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å TV
    }
    return self._send_request("POST", "/v5/position/trading-stop", params)
```

## 5. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Bybit –∏ —Ä–µ–∂–∏–º—ã

### ‚úÖ market_type —Ñ–ª–∞–≥
- **spot vs linear:** –ø—Ä–æ—Ç–∞—â–µ–Ω category –≤–æ –≤—Å–µ –º–µ—Ç–æ–¥—ã (—Å–≤–µ—á–∏, –æ—Ä–¥–µ—Ä–∞, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –ø–æ–∑–∏—Ü–∏–∏)
- **Position mode:** –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω one-way
- **Leverage / Margin mode:** —è–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

```python
# config.py
self.market_type = "linear"  # spot vs linear

# bybit_api.py - category –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö
params = {"category": self.market_type, "symbol": symbol}
```

## 6. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ, —á–∞—Å—Ç–∏—á–Ω—ã–µ/–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

### ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞
- **orderLinkId = trade_id:** –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é
- **–ß–∞—Å—Ç–∏—á–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:** –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `cumExecQty == qty`
- **Crash-safe state:** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ durable-storage (SQLite)

```python
# kwin_strategy.py - crash-safe state
self.last_processed_bar_ts = 0  # –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ crash
self.trade_id = None
self.entry_price = None
self.entry_sl = None
self.strategy_version = "2.0.1"  # –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
```

## 7. –û—Ç–∫–∞–∑—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### ‚úÖ Crash-safe state
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:** `last_processed_bar_ts, trade_id, entry_price, entry_sl, armed, last_sl` –≤ SQLite
- **Circuit breaker:** –ø—Ä–∏ 5 –ø–æ–¥—Ä—è–¥ API-–æ—à–∏–±–∫–∞—Ö - —Å—Ç–æ–ø —Ç–æ—Ä–≥–æ–≤
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–∏

## 8. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- **Latency –∑–∞–ø—Ä–æ—Å–∞, —á–∞—Å—Ç–æ—Ç–∞ –∞–ø–¥–µ–π—Ç–∞ SL, –∫–æ–ª-–≤–æ —É–ª—É—á—à–µ–Ω–∏–π SL**
- **avg RR, win-rate, max adverse excursion, max favorable excursion**
- **–ê–ª–µ—Ä—Ç—ã:** –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ä–∞–∑–≤–æ—Ä–æ—Ç, —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∏—Ä–∂–µ–π

## 9. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ PnL

### ‚úÖ PnL = realized + fees
- **–§–∞–Ω–¥–∏–Ω–≥ —É—á—Ç—ë–Ω:** –¥–ª—è –ø–µ—Ä–ø—Å–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã "TV-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π" –∏ "—Ä–µ–∞–ª—å–Ω—ã–π –±–∏—Ä–∂–µ–≤–æ–π"
- **Equity:** –æ—Ç `walletBalance + unrealizedPnL` (–ø–æ mark price)

## 10. –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

### ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥:** `canEnterLong/Short` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–∏ 15m
- **min stop size:** —É–±—Ä–∞–Ω —Ö–∞—Ä–¥–∫–æ–¥ ‚â• 5 —Ç–∏–∫–æ–≤, —Å–¥–µ–ª–∞–Ω–æ –æ–ø—Ü–∏–µ–π
- **–°–ø—Ä–µ–¥/—Å–∫–æ–ª—å–∂–µ–Ω–∏–µ:** –±—É—Ñ–µ—Ä 1-2 —Ç–∏–∫–∞ –≤ —Ä–∞—Å—á—ë—Ç expected-PnL
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** `strategy_version` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏/–ª–æ–≥–µ

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

### **98-99% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π**

‚úÖ **–í—Å–µ 12 —Ä–∞–∑–¥–µ–ª–æ–≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã**  
‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ —É—á—Ç–µ–Ω—ã**  
‚úÖ **–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–µ**  
‚úÖ **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Pine Script –∏ Bybit API v5**

### –ì–æ—Ç–æ–≤—ã–µ –∞—Ä—Ö–∏–≤—ã:
- `kwin-trading-bot-v2.0-tech-requirements-final.zip` - –ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã